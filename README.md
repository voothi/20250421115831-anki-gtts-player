# gTTS Player with Piper Fallback for Anki

An enhanced Anki add-on that provides Text-to-Speech (TTS) functionality with a seamless offline fallback, ensuring your study flow is never interrupted.

[![Version](https://img.shields.io/badge/version-v2.3.2--mod-blue)](https://github.com/voothi/20250421115831-anki-gtts-player) [![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

> **Note:** This is a modified fork of the official **gTTS Player** add-on. The original source code (as of November 17, 2025) can be found in the [official Anki Add-ons repository](https://github.com/ankitects/anki-addons/tree/main/code/gtts_player) and on [AnkiWeb](https://ankiweb.net/shared/info/391644525).

This enhanced version uses Google's Text-to-Speech service when online but automatically switches to a local, high-quality Piper TTS engine when an internet connection is unavailable or slow.

This project is part of the **[Kardenwort](https://github.com/kardenwort)** environment, designed to create a focused and efficient learning ecosystem.

## Table of Contents

- [gTTS Player with Piper Fallback for Anki](#gtts-player-with-piper-fallback-for-anki)
  - [Table of Contents](#table-of-contents)
  - [Project Philosophy](#project-philosophy)
  - [Features](#features)
  - [How It Works](#how-it-works)
  - [Prerequisites](#prerequisites)
  - [Installation](#installation)
  - [Configuration](#configuration)
  - [Related Projects](#related-projects)
  - [License](#license)

## Project Philosophy

The primary goal of this enhancement is to create a self-sufficient study environment. Whether you are on the go with limited mobile data or wish to disconnect completely for a focused study session, this add-on ensures your audio cards work flawlessly. By leveraging a local TTS engine, it saves bandwidth, works entirely offline, and removes dependency on an active internet connection.

[Back to Top](#table-of-contents)

## Features

-   **Online & Offline Modes**: Utilizes Google's high-quality gTTS service online and seamlessly falls back to a local Piper TTS engine offline.
-   **Automatic Fallback**: If gTTS fails or times out, Piper is used automatically. No broken audio, no interruptions.
-   **On-the-Fly Engine Switching**: Instantly switch between `gTTS` and `Piper` as the primary engine from the `Tools` menu in Anki **without restarting**.
-   **English Voice Correction**: Includes a fix for the original add-on's handling of English accents, ensuring British English (`en_GB`) is correctly mapped and available for use.
-   **Configurable Timeout**: Prevents Anki from freezing by setting a custom timeout for web requests.
-   **No Template Changes Required**: Works out-of-the-box with your existing card templates that use the standard `{{tts...}}` syntax.

[Back to Top](#table-of-contents)

## How It Works

The add-on intercepts Anki's default TTS requests and uses one of two modes:

1.  **gTTS Mode (Default)**: It first attempts to generate audio via the gTTS API.
    -   If the request exceeds the configured timeout or fails due to a network error, it automatically calls the local Piper TTS script as a fallback.
    -   Successfully fetched gTTS files are cached permanently as `.mp3` for future use.

2.  **Piper Mode**: It directly calls the `piper-tts.py` script to generate audio locally. This mode is ideal for fully offline use. Audio generated by Piper is not cached, ensuring it is generated live on each playback request.

[Back to Top](#table-of-contents)

## Prerequisites

1.  **Anki**: The Anki desktop application must be running.
2.  **Python 3**: A separate Python 3 installation is required to run the Piper TTS script.
3.  **Piper TTS Utility**: You must have the [Piper TTS Command-Line Utility](https://github.com/voothi/20241206010110-piper-tts) project downloaded and configured.

## Installation

You need to manually place the add-on's code into Anki's `addons21` folder.

**Step 1: Get the Add-on Code**

You can either clone the repository using Git or download it as a ZIP file.

-   **Method A: Git Clone** (Recommended for easier updates)
    ```bash
    # This command clones the repository directly into a folder named '391644525'
    git clone https://github.com/voothi/20250421115831-anki-gtts-player.git 391644525
    ```
-   **Method B: Download ZIP**
    1.  Click the `Code` button on this repository's page, then `Download ZIP`.
    2.  Extract the ZIP file.
    3.  Rename the extracted folder (e.g., `20250421115831-anki-gtts-player-main`) to `391644525`.

**Step 2: Locate your Anki `addons21` Folder**

You can find this folder in Anki by going to `Tools > Add-ons > View Files`. Typical locations are:
-   **Windows**: `C:\Users\%USERNAME%\AppData\Roaming\Anki2\addons21`
-   **macOS**: `~/Library/Application Support/Anki2/addons21`
-   **Linux**: `~/.local/share/Anki2/addons21`

**Step 3: Install the Add-on**

Move the folder named `391644525` (from Step 1) into the `addons21` directory.

**Step 4: Set up the Piper TTS Utility**

Follow the installation instructions in the [Piper TTS Utility repository](https://github.com/voothi/20241206010110-piper-tts).

**Step 5: Configure This Add-on**

1.  Inside the new `391644525` folder, create a file named `config.json`.
2.  Copy the content from the **Configuration** section below into this file.
3.  **Crucially, update the paths** in `config.json` to point to your Python executable and the `piper_tts.py` script.

**Step 6: Restart Anki**

Close and reopen Anki for the changes to take effect.

[Back to Top](#table-of-contents)

## Configuration

Create a `config.json` file in the add-on's directory (`addons21/391644525`) with the following content.

```json
{
    "tts_engine": "gTTS",
    "gtts_timeout_sec": 5,
    "piper_python_path": "C:/Python/Python312/python.exe",
    "piper_script_path": "U:/voothi/20241206010110-piper-tts/piper_tts.py"
}
```

| Key                   | Description                                                                    | Example Value                                                             |
| --------------------- | ------------------------------------------------------------------------------ | ------------------------------------------------------------------------- |
| `tts_engine`          | The default TTS engine. Can be `gTTS` or `Piper`. Change it via the Tools menu.| `"gTTS"`                                                                  |
| `gtts_timeout_sec`    | Seconds to wait for Google's API before timing out and using Piper.            | `5`                                                                       |
| `piper_python_path`   | **(Required)** Full path to your Python 3 executable.                          | `"C:/Python/Python312/python.exe"`                                        |
| `piper_script_path`   | **(Required)** Full path to the `piper_tts.py` script.                         | `"U:/voothi/20241206010110-piper-tts/piper_tts.py"`                        |


[Back to Top](#table-of-contents)

## Related Projects

-   [**Piper TTS Command-Line Utility**](https://github.com/voothi/20241206010110-piper-tts): The local TTS engine that this add-on depends on for its offline functionality.
-   [**No TTS Player for Anki**](https://github.com/voothi/20250902105308-anki-no-tts/): A companion add-on to temporarily or permanently silence all TTS fields (`{{tts...}}`) without needing to edit card templates.

[Back to Top](#table-of-contents)

## License

[MIT](./LICENSE)

[Back to Top](#table-of-contents)